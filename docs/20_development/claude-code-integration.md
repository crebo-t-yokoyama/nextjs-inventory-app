# Claude Code 連携ガイド

## 🤖 概要

このテンプレートは Claude Code での開発を最適化するよう設計されています。Claude Code の機能を最大限活用するための詳細なガイドです。

> **基本設定は [`CLAUDE.md`](../../CLAUDE.md) を参照してください**

### 本ドキュメントの対象
- Claude Code を使った効率的な開発方法
- 具体的な依頼方法とベストプラクティス
- トラブルシューティング

## 🛠 Claude Code MCP (Model Context Protocol)

### Supabase MCP Server
このテンプレートでは **Supabase MCP Server** を活用できます。

#### 利用可能な機能
```bash
# データベース操作
- テーブル作成・変更・削除
- データの挿入・更新・削除
- クエリ実行・確認

# スキーマ管理
- マイグレーション実行
- インデックス作成
- RLS（Row Level Security）設定

# 開発ブランチ管理
- 開発用ブランチ作成
- 本番との分離
- マージ・リセット操作
```

#### MCP使用例
```typescript
// Claude Code に以下のように依頼
"Supabaseにユーザープロフィールテーブルを作成して、
 必要なRLS設定とインデックスも含めてください"

// 自動実行される操作
// 1. テーブル定義作成
// 2. RLSポリシー設定
// 3. インデックス作成
// 4. TypeScript型定義生成
```

## 📋 効果的な依頼方法

### 1. 具体的で構造化された依頼

#### ❌ 悪い例
```
"ユーザー機能作って"
```

#### ✅ 良い例
```
"ユーザープロフィール管理機能を実装してください。

要件:
- プロフィール表示・編集機能
- アバター画像アップロード
- バイオ・連絡先情報管理
- 変更履歴の記録

制約:
- 認証必須（Auth.js）
- Supabase RLS使用
- shadcn/ui コンポーネント使用
- TypeScript strict mode

実装範囲:
1. API Routes（CRUD）
2. フロントエンドフォーム
3. バリデーション（Zod）
4. ユニットテスト
5. E2Eテスト"
```

### 2. コンテキスト情報の提供

#### プロジェクト状況の共有
```
"現在、基本的な認証機能までが実装済みです。
既存のユーザーテーブルに以下のカラムを追加して、
プロフィール機能を拡張したいです:

- avatar_url: TEXT
- bio: TEXT
- website: VARCHAR
- location: VARCHAR

既存のAPIパターンに合わせて実装してください。"
```

#### 技術的制約の明示
```
"パフォーマンス要件:
- 初期読み込み: 2秒以内
- 画像アップロード: 10MB上限
- リアルタイム更新対応

セキュリティ要件:
- 自分のプロフィールのみ編集可能
- 画像アップロード時のウイルスチェック
- XSS対策必須"
```

## 🎯 開発段階別の活用法

### 1. 設計段階

#### API設計相談
```
"ECサイトの商品管理APIを設計したいです。

商品エンティティ:
- 基本情報（名前、説明、価格）
- カテゴリ・タグ
- 在庫管理
- 画像・バリアント

RESTful設計で、適切なエンドポイント構成と
レスポンス形式を提案してください。"
```

#### データベース設計
```
"商品管理システムのデータベース設計をお願いします。

要件:
- 商品のカテゴリ分類（階層構造）
- 在庫管理（複数倉庫対応）
- 価格履歴管理
- 商品画像管理

正規化・パフォーマンス・拡張性を考慮した
テーブル設計とリレーションを提案してください。"
```

### 2. 実装段階

#### 機能実装
```
"商品検索機能を実装してください。

仕様:
- キーワード検索（名前・説明）
- カテゴリフィルター
- 価格範囲フィルター
- ソート機能（価格・人気順）
- ページネーション
- 検索履歴保存

フロントエンド・バックエンド・データベースクエリ
すべて含めて実装してください。"
```

#### バグ修正
```
"ユーザー登録時に以下のエラーが発生します:

Error: duplicate key value violates unique constraint "users_email_key"

状況:
- 既存ユーザーと同じメールアドレスで登録時
- エラーハンドリングが不十分
- ユーザーに適切なメッセージが表示されない

適切なエラーハンドリングと
ユーザーフレンドリーなメッセージ表示を実装してください。"
```

### 3. 最適化段階

#### パフォーマンス改善
```
"商品一覧ページの読み込みが遅いです。

現状:
- 1000件の商品データを一度に取得
- 画像の遅延読み込みなし
- 検索時に全テーブルスキャン

以下を実装してパフォーマンスを改善してください:
- 仮想スクロール
- 画像の遅延読み込み
- インデックス最適化
- キャッシング戦略"
```

#### セキュリティ強化
```
"現在の実装をセキュリティの観点でレビューし、
改善点を特定・修正してください。

チェック項目:
- SQLインジェクション対策
- XSS対策
- CSRF対策
- 認証・認可の妥当性
- 入力値検証の網羅性
- セキュリティヘッダー設定"
```

## 🧪 テスト関連の依頼

### ユニットテスト生成
```
"以下のユーザープロフィール更新APIに対する
包括的なユニットテストを作成してください:

テストケース:
- 正常系: 有効なデータでの更新
- 異常系: バリデーションエラー
- 異常系: 認証エラー
- 異常系: 権限エラー
- 境界値テスト
- エラーレスポンス形式の確認

Vitestとjsdomを使用してください。"
```

### E2Eテスト作成
```
"ユーザー登録からプロフィール設定までの
E2Eテストシナリオを作成してください。

シナリオ:
1. 新規ユーザー登録
2. メール認証
3. 初回ログイン
4. プロフィール情報入力
5. アバター画像アップロード
6. 設定保存確認

Playwrightを使用し、エラーケースも含めてください。"
```

## 📚 ドキュメント生成

### API仕様書
```
"実装済みのAPI Routesを基に、
OpenAPI 3.0形式のAPI仕様書を生成してください。

含める内容:
- エンドポイント一覧
- リクエスト・レスポンス形式
- 認証要件
- エラーコード定義
- 使用例

開発者が理解しやすい形式でお願いします。"
```

### 運用ドキュメント
```
"本番環境での運用手順書を作成してください。

内容:
- デプロイ手順
- 環境変数設定
- データベースマイグレーション
- バックアップ・復旧手順
- 監視・アラート設定
- トラブルシューティング

新しいチームメンバーでも実行できるレベルで
詳細に記載してください。"
```

## 🔧 開発環境最適化

### Claude Code Hooks設定

#### プロジェクト固有フック例
```bash
# .claude/hooks/pre-commit
#!/bin/bash
# コミット前の自動チェック
pnpm lint
pnpm type-check
pnpm test --run

# .claude/hooks/post-merge
#!/bin/bash
# マージ後の自動実行
pnpm install
pnpm build
```

### 設定ファイル最適化
```json
{
  "claude": {
    "project_type": "nextjs_supabase_template",
    "auto_read_files": [
      "CLAUDE.md",
      "docs/00_common/**/*.md",
      "src/types/**/*.ts",
      "src/lib/validations.ts"
    ],
    "ignore_patterns": [
      "node_modules/**",
      ".next/**",
      "*.log"
    ],
    "preferred_tools": [
      "supabase_mcp",
      "typescript",
      "vitest",
      "playwright"
    ]
  }
}
```

## 📋 依頼テンプレート集

### 新機能開発
```markdown
## 機能: [機能名]

### 要件
- [要件1]
- [要件2]

### 技術制約
- [制約1]
- [制約2]

### 実装範囲
- [ ] データベース設計
- [ ] API実装
- [ ] フロントエンド実装
- [ ] テスト作成
- [ ] ドキュメント更新

### 参考資料
- [関連ファイル]
- [参考URL]
```

### バグ修正
```markdown
## バグ: [バグ概要]

### 現象
[詳細な現象説明]

### 再現手順
1. [手順1]
2. [手順2]

### 期待動作
[本来の動作]

### 環境情報
- OS: [OS情報]
- ブラウザ: [ブラウザ情報]
- 関連ファイル: [ファイルパス]

### エラーログ
```
[エラーメッセージ]
```
```

### コードレビュー
```markdown
## レビュー観点

### セキュリティ
- [ ] 認証・認可チェック
- [ ] 入力値検証
- [ ] SQLインジェクション対策

### パフォーマンス
- [ ] クエリ効率
- [ ] メモリ使用量
- [ ] レンダリング最適化

### 保守性
- [ ] コード可読性
- [ ] テストカバレッジ
- [ ] エラーハンドリング

### 対象コード
[ファイルパスまたはPR番号]
```

## 🎯 ベストプラクティス

### 効率的な開発のために

1. **事前準備**
   - 要件を明確化
   - 既存コードの理解
   - 技術制約の整理

2. **段階的実装**
   - 小さな単位で依頼
   - 動作確認しながら進行
   - 早期のフィードバック

3. **品質保証**
   - テスト作成を忘れずに
   - セキュリティレビュー実施
   - パフォーマンス確認

4. **ドキュメント化**
   - 実装内容の記録
   - 設計判断の理由保存
   - 運用知識の共有

### 注意点

- **過度な依存は避ける**: Claude Code は強力なツールですが、理解なしに使用しない
- **セキュリティ確認**: 生成されたコードのセキュリティは必ず確認
- **テスト実行**: 自動生成されたテストも実際に実行して確認
- **コードレビュー**: 人間による最終確認は必須