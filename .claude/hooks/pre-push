#!/bin/bash

# Pre-push hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹ãƒ—ãƒƒã‚·ãƒ¥å‰ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

echo "ğŸš€ Pre-push checks..."

# 1. E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæœ¬æ ¼çš„ãªçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
echo "ğŸ­ Running E2E tests..."
if command -v pnpm &> /dev/null; then
    if [ -f "playwright.config.ts" ]; then
        pnpm test:e2e || {
            echo "âŒ E2E tests failed"
            exit 1
        }
    else
        echo "âš ï¸  No E2E tests configuration found"
    fi
else
    echo "âš ï¸  pnpm not found, skipping E2E tests"
fi

# 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running security checks..."
if command -v pnpm &> /dev/null; then
    # è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    pnpm audit --audit-level moderate || {
        echo "âš ï¸  Security vulnerabilities found - please review"
    }
else
    echo "âš ï¸  pnpm not found, skipping security checks"
fi

# 3. æœ¬ç•ªãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
echo "ğŸ­ Testing production build..."
if command -v pnpm &> /dev/null; then
    NODE_ENV=production pnpm build || {
        echo "âŒ Production build failed"
        exit 1
    }
else
    echo "âš ï¸  pnpm not found, skipping production build test"
fi

# 4. ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
echo "ğŸ“Š Checking bundle size..."
if command -v pnpm &> /dev/null && [ -d ".next" ]; then
    # Next.js ã® bundle analyzer ãŒã‚ã‚Œã°å®Ÿè¡Œ
    if grep -q "@next/bundle-analyzer" package.json 2>/dev/null; then
        echo "ğŸ“ˆ Bundle analysis available - check .next/analyze for details"
    fi
else
    echo "âš ï¸  Build output not found, skipping bundle size check"
fi

echo "âœ… All pre-push checks passed!"