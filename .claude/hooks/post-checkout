#!/bin/bash

# Post-checkout hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆå¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

# å¼•æ•°ã‚’å–å¾—ï¼ˆå‰ã®HEADã€æ–°ã—ã„HEADã€ãƒ–ãƒ©ãƒ³ãƒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‹ï¼‰
previous_head=$1
new_head=$2
branch_checkout=$3

# ãƒ–ãƒ©ãƒ³ãƒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œ
if [ "$branch_checkout" = "1" ]; then
    echo "ğŸ”„ Post-checkout operations..."

    # 1. ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
    echo "ğŸ“¦ Checking for dependency changes..."
    if command -v pnpm &> /dev/null; then
        if [ -f "package.json" ]; then
            # package.json ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! git diff --quiet "$previous_head" "$new_head" -- package.json 2>/dev/null; then
                echo "ğŸ“‹ package.json changed - updating dependencies..."
                pnpm install || {
                    echo "âš ï¸  Failed to install dependencies"
                }
            else
                echo "âœ… No dependency changes detected"
            fi
        fi
    else
        echo "âš ï¸  pnpm not found, skipping dependency check"
    fi

    # 2. ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    echo "âš™ï¸  Checking environment configuration..."
    if [ ! -f ".env.local" ]; then
        echo "âš ï¸  .env.local not found - you may need to create it"
        if [ -f ".env.example" ]; then
            echo "ğŸ“ .env.example is available as a template"
        fi
    fi

    # 3. TypeScriptè¨­å®šã®ç¢ºèª
    echo "ğŸ“ Checking TypeScript configuration..."
    if command -v pnpm &> /dev/null; then
        pnpm type-check || {
            echo "âš ï¸  TypeScript errors found in this branch"
        }
    fi

    # 4. Next.js ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    echo "ğŸ§¹ Cleaning build cache..."
    if [ -d ".next" ]; then
        rm -rf .next
        echo "âœ… Next.js cache cleared"
    fi

    echo "âœ… Post-checkout operations completed!"
else
    echo "ğŸ“„ File checkout detected - skipping branch-specific operations"
fi