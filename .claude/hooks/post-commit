#!/bin/bash

# Post-commit hook for project knowledge accumulation
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŸ¥è­˜è‡ªå‹•è“„ç©ã‚·ã‚¹ãƒ†ãƒ 

set -e

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_HASH=$(git log -1 --pretty=%H | cut -c1-7)
COMMIT_DATE=$(date '+%Y-%m-%d %H:%M')
AUTHOR=$(git log -1 --pretty=%an)

echo "ðŸ“ Updating project documentation..."

# é‡è¦ãªå¤‰æ›´ã‚’development-log.mdã«è¨˜éŒ²
if [[ $COMMIT_MSG =~ ^(feat|fix|refactor|perf): ]]; then
    {
        echo ""
        echo "### $COMMIT_DATE - $COMMIT_MSG"
        echo "- **å¤‰æ›´è€…**: $AUTHOR"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: $COMMIT_HASH"
        echo "- **è©³ç´°**: $(echo "$COMMIT_MSG" | tail -n +2 | head -n 3)"
        echo ""
    } >> docs/99_other/development-log.md
    
    echo "âœ… Development log updated"
fi

# APIå¤‰æ›´ã‚’æ¤œå‡º
if git diff --name-only HEAD~1 | grep -q "src/app/api/"; then
    {
        echo ""
        echo "### $COMMIT_DATE - APIå¤‰æ›´æ¤œå‡º"
        echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: $(git diff --name-only HEAD~1 | grep "src/app/api/" | tr '\n' ', ')"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: $COMMIT_HASH - $COMMIT_MSG"
        echo "- **è¦ç¢ºèª**: docs/10_architect/api-design.md ã®æ›´æ–°ã‚’æ¤œè¨Ž"
        echo ""
    } >> docs/99_other/api-changes.md
    
    echo "âš ï¸  API changes detected - consider updating API documentation"
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžå¤‰æ›´ã‚’æ¤œå‡º
if git diff --name-only HEAD~1 | grep -q -E "(migration|schema|database|supabase)"; then
    {
        echo ""
        echo "### $COMMIT_DATE - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£å¤‰æ›´"
        echo "- **å¤‰æ›´å†…å®¹**: $COMMIT_MSG"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: $COMMIT_HASH"
        echo "- **è¦ç¢ºèª**: docs/10_architect/database-design.md ã®æ›´æ–°ã‚’æ¤œè¨Ž"
        echo ""
    } >> docs/99_other/development-log.md
    
    echo "ðŸ—„ï¸  Database changes detected - consider updating database documentation"
fi

# åž‹å®šç¾©å¤‰æ›´ã‚’æ¤œå‡º
if git diff --name-only HEAD~1 | grep -q "src/types/"; then
    echo "ðŸ“Š Type definition changes detected - TypeScript types may need documentation update"
fi

# ãƒ†ã‚¹ãƒˆè¿½åŠ ã‚’æ¤œå‡º
if git diff --name-only HEAD~1 | grep -q -E "(\\.test\\.|__tests__|e2e)"; then
    echo "ðŸ§ª Test changes detected - consider updating test documentation if needed"
fi

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£å¤‰æ›´ã‚’æ¤œå‡º
if [[ $COMMIT_MSG =~ (security|auth|rls|validation) ]] || git diff --name-only HEAD~1 | grep -q -E "(auth|security|validation)"; then
    {
        echo ""
        echo "### $COMMIT_DATE - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£å¤‰æ›´"
        echo "- **å†…å®¹**: $COMMIT_MSG"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: $COMMIT_HASH"
        echo "- **è¦ç¢ºèª**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’æ¤œè¨Ž"
        echo ""
    } >> docs/99_other/development-log.md
    
    echo "ðŸ”’ Security-related changes detected"
fi

# TODO/æŠ€è¡“çš„è² å‚µã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
if [ -x ".claude/hooks/todo-scanner" ]; then
    .claude/hooks/todo-scanner
fi

echo "ðŸ“š Project knowledge accumulation completed"