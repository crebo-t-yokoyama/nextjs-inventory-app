#!/bin/bash

# Pre-deploy hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

echo "ğŸš€ Pre-deployment checks..."

# 1. æœ¬ç•ªç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
echo "âš™ï¸  Checking production environment variables..."
required_vars=("NEXTAUTH_SECRET" "NEXT_PUBLIC_SUPABASE_URL" "NEXT_PUBLIC_SUPABASE_ANON_KEY" "SUPABASE_SERVICE_ROLE_KEY")
missing_vars=()

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        missing_vars+=("$var")
    fi
done

if [ ${#missing_vars[@]} -ne 0 ]; then
    echo "âŒ Missing required environment variables:"
    printf '  - %s\n' "${missing_vars[@]}"
    exit 1
fi

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
echo "ğŸ—„ï¸  Checking database migrations..."
if [ -d "supabase/migrations" ]; then
    # æœªé©ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    echo "ğŸ“‹ Database migrations found - ensure all migrations are applied to production"
    echo "âš ï¸  Run 'supabase db push' if needed before deployment"
fi

# 3. æœ¬ç•ªãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
echo "ğŸ­ Testing production build..."
if command -v pnpm &> /dev/null; then
    NODE_ENV=production pnpm build || {
        echo "âŒ Production build failed"
        exit 1
    }
    
    # ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if [ -d ".next" ]; then
        echo "ğŸ“¦ Build completed successfully"
        if [ -f ".next/static/chunks/pages/_app-*.js" ]; then
            app_size=$(du -h .next/static/chunks/pages/_app-*.js | cut -f1)
            echo "ğŸ“Š App bundle size: $app_size"
        fi
    fi
else
    echo "âŒ pnpm not found - cannot verify production build"
    exit 1
fi

# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€çµ‚ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running final security audit..."
if command -v pnpm &> /dev/null; then
    pnpm audit --audit-level critical || {
        echo "âŒ Critical security vulnerabilities found"
        exit 1
    }
    
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¿¡é ¼æ€§ãƒã‚§ãƒƒã‚¯
    pnpm audit --audit-level high || {
        echo "âš ï¸  High severity vulnerabilities found - review before deployment"
    }
else
    echo "âš ï¸  Cannot run security audit without pnpm"
fi

# 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
echo "âš¡ Running performance checks..."
if command -v pnpm &> /dev/null && [ -f "playwright.config.ts" ]; then
    # Lighthouse CI ãŒã‚ã‚Œã°å®Ÿè¡Œ
    if command -v lhci &> /dev/null; then
        echo "ğŸ” Running Lighthouse CI..."
        lhci autorun || {
            echo "âš ï¸  Performance checks failed - review before deployment"
        }
    else
        echo "âš ï¸  Lighthouse CI not available - manual performance testing recommended"
    fi
fi

# 6. ä¾å­˜é–¢ä¿‚ã®æœ€çµ‚ç¢ºèª
echo "ğŸ“¦ Verifying dependencies..."
if command -v pnpm &> /dev/null; then
    # lockfile ã®æ•´åˆæ€§ç¢ºèª
    pnpm install --frozen-lockfile || {
        echo "âŒ Dependency lockfile mismatch"
        exit 1
    }
fi

# 7. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
echo "ğŸ’¾ Checking backup status..."
echo "âš ï¸  Ensure database and critical data backups are recent"
echo "ğŸ“… Last backup should be within 24 hours for production deployment"

echo "âœ… All pre-deployment checks passed!"
echo "ğŸš€ Ready for production deployment"