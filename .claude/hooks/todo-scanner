#!/bin/bash

# TODO Scanner - ã‚³ãƒ¼ãƒ‰å†…ã®TODO/FIXME/HACKã‚’æ¤œå‡º
# Claude Code hooksç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

echo "ğŸ” Scanning for TODOs, FIXMEs, and technical debt..."

# æ¤œç´¢å¯¾è±¡ãƒ‘ã‚¿ãƒ¼ãƒ³
PATTERNS="TODO|FIXME|HACK|XXX|@deprecated"

# æ¤œç´¢å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
SEARCH_DIRS="src"

# é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³
EXCLUDE_PATTERN="node_modules|\.next|\.git|dist|build"

# çµæœãƒ•ã‚¡ã‚¤ãƒ«
OUTPUT_FILE="docs/99_other/todo-scan-results.tmp"

# å‰å›ã®çµæœã¨æ¯”è¼ƒç”¨
PREV_FILE="docs/99_other/todo-scan-previous.tmp"

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢
> "$OUTPUT_FILE"

# TODO/FIXMEç­‰ã‚’æ¤œç´¢
if command -v rg &> /dev/null; then
    # ripgrepãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
    rg -n -i "($PATTERNS):" $SEARCH_DIRS 2>/dev/null | while IFS=: read -r file line content; do
        # å„ªå…ˆåº¦åˆ¤å®š
        priority="ä½"
        if echo "$content" | grep -qi -E "(security|auth|vulnerability|critical|urgent)"; then
            priority="é«˜"
        elif echo "$content" | grep -qi -E "(performance|refactor|debt|deprecated)"; then
            priority="ä¸­"
        fi
        
        echo "- [ ] **[$priority]** $file:$line - $content" >> "$OUTPUT_FILE"
    done
else
    # grepãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    find $SEARCH_DIRS -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) ! -path "*/node_modules/*" ! -path "*/.next/*" -exec grep -Hn -i -E "($PATTERNS):" {} \; 2>/dev/null | while IFS=: read -r file line content; do
        priority="ä½"
        if echo "$content" | grep -qi -E "(security|auth|vulnerability|critical|urgent)"; then
            priority="é«˜"
        elif echo "$content" | grep -qi -E "(performance|refactor|debt|deprecated)"; then
            priority="ä¸­"
        fi
        
        echo "- [ ] **[$priority]** $file:$line - $content" >> "$OUTPUT_FILE"
    done
fi

# çµæœæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
total_count=$(wc -l < "$OUTPUT_FILE" 2>/dev/null || echo 0)
high_count=$(grep -c "\*\*\[é«˜\]\*\*" "$OUTPUT_FILE" 2>/dev/null || echo 0)
medium_count=$(grep -c "\*\*\[ä¸­\]\*\*" "$OUTPUT_FILE" 2>/dev/null || echo 0)
low_count=$(grep -c "\*\*\[ä½\]\*\*" "$OUTPUT_FILE" 2>/dev/null || echo 0)

# å‰å›ã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
new_todos=0
if [ -f "$PREV_FILE" ]; then
    if ! diff -q "$OUTPUT_FILE" "$PREV_FILE" >/dev/null 2>&1; then
        new_todos=1
        echo "ğŸ“ New TODOs or changes detected"
    fi
fi

# ç¾åœ¨ã®çµæœã‚’ä¿å­˜
cp "$OUTPUT_FILE" "$PREV_FILE" 2>/dev/null || true

# çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
echo "ğŸ“Š TODO Statistics:"
echo "   Total: $total_count"
echo "   High: $high_count, Medium: $medium_count, Low: $low_count"

# æ–°ã—ã„TODOãŒã‚ã‚‹å ´åˆã¯technical-debt.mdã‚’æ›´æ–°
if [ $new_todos -eq 1 ] && [ $total_count -gt 0 ]; then
    echo "ğŸ”„ Updating technical debt documentation..."
    
    # technical-debt.mdã®çµ±è¨ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    if [ -f "docs/99_other/technical-debt.md" ]; then
        # çµ±è¨ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆç°¡å˜ãªç½®æ›ï¼‰
        sed -i "s/\*\*ç·TODOæ•°\*\*: [0-9]* å€‹/**ç·TODOæ•°**: $total_count å€‹/" docs/99_other/technical-debt.md 2>/dev/null || true
        sed -i "s/\*\*é«˜å„ªå…ˆåº¦\*\*: [0-9]* å€‹/**é«˜å„ªå…ˆåº¦**: $high_count å€‹/" docs/99_other/technical-debt.md 2>/dev/null || true
        sed -i "s/\*\*ä¸­å„ªå…ˆåº¦\*\*: [0-9]* å€‹/**ä¸­å„ªå…ˆåº¦**: $medium_count å€‹/" docs/99_other/technical-debt.md 2>/dev/null || true
        sed -i "s/\*\*ä½å„ªå…ˆåº¦\*\*: [0-9]* å€‹/**ä½å„ªå…ˆåº¦**: $low_count å€‹/" docs/99_other/technical-debt.md 2>/dev/null || true
    fi
    
    echo "âœ… Technical debt documentation updated"
fi

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -f "$OUTPUT_FILE"

echo "ğŸ” TODO scan completed"