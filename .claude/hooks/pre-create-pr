#!/bin/bash

# Pre-create-PR hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹PRä½œæˆå‰ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

echo "ğŸ“‹ Pre-PR creation checks..."

# 1. å®Œå…¨ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
echo "ğŸ§ª Running complete test suite..."
if command -v pnpm &> /dev/null; then
    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    pnpm test --run || {
        echo "âŒ Unit tests failed"
        exit 1
    }
    
    # E2Eãƒ†ã‚¹ãƒˆ
    if [ -f "playwright.config.ts" ]; then
        pnpm test:e2e || {
            echo "âŒ E2E tests failed"
            exit 1
        }
    fi
else
    echo "âš ï¸  pnpm not found, skipping tests"
fi

# 2. ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
echo "ğŸ“Š Checking code coverage..."
if command -v pnpm &> /dev/null; then
    pnpm test --coverage --run || {
        echo "âš ï¸  Coverage check failed"
    }
else
    echo "âš ï¸  pnpm not found, skipping coverage check"
fi

# 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running security audit..."
if command -v pnpm &> /dev/null; then
    pnpm audit --audit-level high || {
        echo "âš ï¸  High severity vulnerabilities found"
    }
else
    echo "âš ï¸  pnpm not found, skipping security audit"
fi

# 4. ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–ãƒã‚§ãƒƒã‚¯
echo "âš¡ Checking build optimization..."
if command -v pnpm &> /dev/null; then
    NODE_ENV=production pnpm build || {
        echo "âŒ Production build failed"
        exit 1
    }
    
    # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®è­¦å‘Š
    if [ -d ".next" ]; then
        echo "ğŸ“¦ Build completed - review bundle size in .next/analyze if available"
    fi
else
    echo "âš ï¸  pnpm not found, skipping build check"
fi

# 5. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒã‚§ãƒƒã‚¯
echo "ğŸ“š Checking documentation..."
current_branch=$(git rev-parse --abbrev-ref HEAD)
main_branch="main"

# æ–°æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’æ¨å¥¨
if [[ "$current_branch" =~ ^feature/ ]]; then
    echo "ğŸ” Feature branch detected - consider updating documentation:"
    echo "  - README.md"
    echo "  - docs/ directory"
    echo "  - CLAUDE.md (if adding new capabilities)"
fi

# APIå¤‰æ›´ã®å ´åˆã®è­¦å‘Š
if git diff --name-only "$main_branch"..HEAD | grep -q "src/app/api/"; then
    echo "âš ï¸  API changes detected - ensure:"
    echo "  - API documentation is updated"
    echo "  - Breaking changes are documented"
    echo "  - Migration guide is provided if needed"
fi

echo "âœ… Pre-PR checks completed!"
echo "ğŸš€ Ready to create Pull Request"