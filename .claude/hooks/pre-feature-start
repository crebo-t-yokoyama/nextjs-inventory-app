#!/bin/bash

# Pre-feature-start hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹æ–°æ©Ÿèƒ½é–‹ç™ºé–‹å§‹æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

echo "ğŸ†• Starting new feature development..."

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
current_branch=$(git rev-parse --abbrev-ref HEAD)
main_branch="main"

# 1. ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯
echo "ğŸ·ï¸  Checking branch naming convention..."
if [[ "$current_branch" =~ ^(feature|fix|chore|docs|refactor|test)\/[a-z0-9-]+$ ]]; then
    echo "âœ… Branch name follows convention: $current_branch"
    branch_type=$(echo "$current_branch" | cut -d'/' -f1)
    branch_name=$(echo "$current_branch" | cut -d'/' -f2)
else
    echo "âš ï¸  Branch name should follow pattern: type/description"
    echo "   Examples: feature/user-profile, fix/login-bug, chore/update-deps"
    echo "   Current: $current_branch"
fi

# 2. æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã¨ã®åŒæœŸç¢ºèª
echo "ğŸ”„ Checking branch synchronization..."
git fetch origin "$main_branch" || {
    echo "âš ï¸  Failed to fetch latest main branch"
}

# mainã‹ã‚‰ã®å·®åˆ†ç¢ºèª
commits_behind=$(git rev-list --count HEAD..origin/"$main_branch" 2>/dev/null || echo "unknown")
if [ "$commits_behind" != "0" ] && [ "$commits_behind" != "unknown" ]; then
    echo "âš ï¸  Your branch is $commits_behind commits behind main"
    echo "   Consider rebasing: git rebase origin/$main_branch"
else
    echo "âœ… Branch is up to date with main"
fi

# 3. é–¢é€£ã‚¤ã‚·ãƒ¥ãƒ¼ã®ç¢ºèª
echo "ğŸ« Checking for related issues..."
if [[ "$current_branch" =~ [0-9]+ ]]; then
    issue_number=$(echo "$current_branch" | grep -o '[0-9]\+' | head -1)
    echo "ğŸ”— Potential issue number detected: #$issue_number"
    echo "   Ensure this issue exists and is assigned to you"
else
    echo "ğŸ’¡ Consider linking this branch to a GitHub issue"
    echo "   Include issue number in branch name (e.g., feature/123-user-profile)"
fi

# 4. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
echo "âš™ï¸  Checking development environment..."

# Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
if command -v node &> /dev/null; then
    node_version=$(node --version)
    echo "ğŸ“¦ Node.js version: $node_version"
    
    # package.json ã® engines ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    if [ -f "package.json" ] && command -v jq &> /dev/null; then
        required_node=$(jq -r '.engines.node // "not specified"' package.json)
        echo "ğŸ“‹ Required Node.js: $required_node"
    fi
fi

# ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
if [ -f "package.json" ] && command -v pnpm &> /dev/null; then
    echo "ğŸ“¦ Installing/updating dependencies..."
    pnpm install || {
        echo "âŒ Failed to install dependencies"
        exit 1
    }
    echo "âœ… Dependencies are up to date"
fi

# 5. ç’°å¢ƒå¤‰æ•°ç¢ºèª
echo "ğŸ”§ Checking environment configuration..."
if [ ! -f ".env.local" ]; then
    echo "âš ï¸  .env.local not found"
    if [ -f ".env.example" ]; then
        echo "ğŸ“ Creating .env.local from .env.example template"
        cp .env.example .env.local
        echo "âš ï¸  Please update .env.local with your values"
    else
        echo "âŒ No environment template found"
    fi
else
    echo "âœ… Environment configuration exists"
fi

# 6. å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ç¢ºèª
echo "ğŸš€ Checking required services..."
services_to_check=("database" "authentication")
echo "ğŸ“‹ Ensure the following services are running:"
for service in "${services_to_check[@]}"; do
    echo "  - $service"
done

# Supabase ãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèª
if command -v supabase &> /dev/null; then
    if supabase status &> /dev/null; then
        echo "âœ… Supabase local development is running"
    else
        echo "âš ï¸  Supabase local development is not running"
        echo "   Start with: supabase start"
    fi
fi

# 7. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆ
echo "ğŸ—ï¸  Testing development server..."
if command -v pnpm &> /dev/null; then
    echo "ğŸ” Verifying build configuration..."
    pnpm type-check || {
        echo "âŒ TypeScript configuration has errors"
        exit 1
    }
    echo "âœ… TypeScript configuration is valid"
fi

# 8. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒç¢ºèª
echo "ğŸ§ª Checking test environment..."
if command -v pnpm &> /dev/null; then
    echo "ğŸ” Running initial test suite..."
    pnpm test --run || {
        echo "âŒ Existing tests are failing"
        echo "   Fix existing tests before starting new feature development"
        exit 1
    }
    echo "âœ… All existing tests pass"
fi

# 9. é–‹ç™ºãƒ„ãƒ¼ãƒ«ç¢ºèª
echo "ğŸ› ï¸  Checking development tools..."
dev_tools=("git" "node" "pnpm")
missing_tools=()

for tool in "${dev_tools[@]}"; do
    if ! command -v "$tool" &> /dev/null; then
        missing_tools+=("$tool")
    fi
done

if [ ${#missing_tools[@]} -ne 0 ]; then
    echo "âŒ Missing development tools:"
    printf '  - %s\n' "${missing_tools[@]}"
    exit 1
else
    echo "âœ… All required development tools are available"
fi

# 10. æ¨å¥¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
echo "ğŸ’¡ Recommended setup checklist:"
echo "  - [ ] IDE extensions installed (ESLint, Prettier, TypeScript)"
echo "  - [ ] Git hooks configured"
echo "  - [ ] Database schema reviewed"
echo "  - [ ] Design system/UI components understood"
echo "  - [ ] Testing patterns reviewed"

# 11. æ©Ÿèƒ½ã‚¿ã‚¤ãƒ—åˆ¥ã®æ¨å¥¨äº‹é …
echo ""
echo "ğŸ“‹ Type-specific recommendations for '$branch_type':"
case "$branch_type" in
    "feature")
        echo "  - Review existing similar features"
        echo "  - Plan database schema changes"
        echo "  - Consider UI/UX implications"
        echo "  - Plan test coverage"
        ;;
    "fix")
        echo "  - Reproduce the bug locally"
        echo "  - Write a failing test first"
        echo "  - Plan minimal change approach"
        echo "  - Consider regression testing"
        ;;
    "refactor")
        echo "  - Ensure comprehensive test coverage"
        echo "  - Plan backward compatibility"
        echo "  - Document changes thoroughly"
        echo "  - Consider performance impact"
        ;;
    "chore")
        echo "  - Review dependency changes"
        echo "  - Check for breaking changes"
        echo "  - Update documentation"
        echo "  - Test in multiple environments"
        ;;
esac

echo ""
echo "âœ… Feature development environment ready!"
echo "ğŸš€ Happy coding! Remember to commit frequently and write tests."