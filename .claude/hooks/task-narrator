#!/bin/bash

# Task Narrator hook for Claude Code
# Claude Code ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚’éŸ³å£°ã§é€šçŸ¥ã™ã‚‹ãƒ•ãƒƒã‚¯

set -e

# éŸ³å£°å‡ºåŠ›ã®è¨­å®š
VOICE_ENABLED=${CLAUDE_VOICE_ENABLED:-false}
VOICE_LANG=${CLAUDE_VOICE_LANG:-"ja-JP"}
VOICE_RATE=${CLAUDE_VOICE_RATE:-1.0}
VOICE_VOLUME=${CLAUDE_VOICE_VOLUME:-0.7}

# éŸ³å£°å‡ºåŠ›é–¢æ•°
speak() {
    local message="$1"
    local priority="${2:-normal}"  # low, normal, high
    
    if [ "$VOICE_ENABLED" != "true" ]; then
        return 0
    fi
    
    # å„ªå…ˆåº¦ã«ã‚ˆã‚‹éŸ³é‡èª¿æ•´
    local volume="$VOICE_VOLUME"
    case "$priority" in
        "low") volume=$(echo "$VOICE_VOLUME * 0.6" | bc -l 2>/dev/null || echo "$VOICE_VOLUME") ;;
        "high") volume=$(echo "$VOICE_VOLUME * 1.2" | bc -l 2>/dev/null || echo "$VOICE_VOLUME") ;;
    esac
    
    # ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥éŸ³å£°å‡ºåŠ›
    if command -v say &> /dev/null; then
        # macOS
        say -v "Kyoko" -r "$(echo "$VOICE_RATE * 200" | bc -l 2>/dev/null || echo "200")" "$message" &
    elif command -v espeak &> /dev/null; then
        # Linux (espeak)
        espeak -s "$(echo "$VOICE_RATE * 150" | bc -l 2>/dev/null || echo "150")" -a "$(echo "$volume * 100" | bc -l 2>/dev/null || echo "70")" -v "$VOICE_LANG" "$message" &
    elif command -v spd-say &> /dev/null; then
        # Linux (speech-dispatcher)
        spd-say -r "$(echo "$VOICE_RATE * 100 - 100" | bc -l 2>/dev/null || echo "0")" -i "$(echo "$volume * 100" | bc -l 2>/dev/null || echo "70")" "$message" &
    elif command -v powershell &> /dev/null; then
        # Windows (PowerShell)
        powershell -Command "Add-Type -AssemblyName System.Speech; \$speak = New-Object System.Speech.Synthesis.SpeechSynthesizer; \$speak.Rate = $VOICE_RATE; \$speak.Volume = $(echo "$volume * 100" | bc -l 2>/dev/null || echo "70"); \$speak.SpeakAsync('$message')" &
    else
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ™ãƒ«éŸ³
        echo -e "\a" # ã‚·ã‚¹ãƒ†ãƒ ãƒ™ãƒ«
    fi
}

# ã‚¿ã‚¹ã‚¯é–‹å§‹é€šçŸ¥
task_start() {
    local task_name="$1"
    local task_type="${2:-task}"
    
    echo "ğŸ™ï¸  Task narrator: Starting $task_type"
    
    case "$task_type" in
        "commit")
            speak "ã‚³ãƒŸãƒƒãƒˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™" "normal"
            ;;
        "push")
            speak "ãƒ—ãƒƒã‚·ãƒ¥å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™" "normal"
            ;;
        "merge")
            speak "ãƒãƒ¼ã‚¸å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™" "normal"
            ;;
        "checkout")
            speak "ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™" "normal"
            ;;
        "deploy")
            speak "ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™" "high"
            ;;
        "test")
            speak "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™" "normal"
            ;;
        "build")
            speak "ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™" "normal"
            ;;
        *)
            speak "ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã™" "low"
            ;;
    esac
}

# ã‚¿ã‚¹ã‚¯å®Œäº†é€šçŸ¥
task_complete() {
    local task_type="${1:-task}"
    local status="${2:-success}"  # success, error, warning
    
    echo "ğŸ™ï¸  Task narrator: $task_type completed with status: $status"
    
    case "$status" in
        "success")
            case "$task_type" in
                "commit")
                    speak "ã‚³ãƒŸãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ" "normal"
                    ;;
                "push")
                    speak "ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸ" "normal"
                    ;;
                "merge")
                    speak "ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ" "normal"
                    ;;
                "deploy")
                    speak "ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" "high"
                    ;;
                "test")
                    speak "å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ" "normal"
                    ;;
                "build")
                    speak "ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ" "normal"
                    ;;
                *)
                    speak "ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ" "low"
                    ;;
            esac
            ;;
        "error")
            case "$task_type" in
                "commit")
                    speak "ã‚³ãƒŸãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" "high"
                    ;;
                "push")
                    speak "ãƒ—ãƒƒã‚·ãƒ¥ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" "high"
                    ;;
                "deploy")
                    speak "ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„" "high"
                    ;;
                "test")
                    speak "ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ" "high"
                    ;;
                "build")
                    speak "ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ" "high"
                    ;;
                *)
                    speak "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" "high"
                    ;;
            esac
            ;;
        "warning")
            speak "è­¦å‘ŠãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„" "normal"
            ;;
    esac
}

# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é€šçŸ¥
task_progress() {
    local step="$1"
    local total="${2:-}"
    local description="${3:-}"
    
    if [ -n "$total" ]; then
        echo "ğŸ™ï¸  Progress: $step/$total - $description"
        if [ "$step" = "1" ]; then
            speak "å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™" "low"
        elif [ "$step" = "$total" ]; then
            speak "æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§ã™" "low"
        fi
    else
        echo "ğŸ™ï¸  Step: $description"
        case "$description" in
            *"ãƒ†ã‚¹ãƒˆ"*)
                speak "ãƒ†ã‚¹ãƒˆä¸­" "low"
                ;;
            *"ãƒ“ãƒ«ãƒ‰"*)
                speak "ãƒ“ãƒ«ãƒ‰ä¸­" "low"
                ;;
            *"ãƒã‚§ãƒƒã‚¯"*)
                speak "ãƒã‚§ãƒƒã‚¯ä¸­" "low"
                ;;
        esac
    fi
}

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    cat << EOF
Task Narrator - Claude Code éŸ³å£°é€šçŸ¥ãƒ•ãƒƒã‚¯

ä½¿ç”¨æ–¹æ³•:
  task_start <task_name> [task_type]     # ã‚¿ã‚¹ã‚¯é–‹å§‹é€šçŸ¥
  task_complete [task_type] [status]     # ã‚¿ã‚¹ã‚¯å®Œäº†é€šçŸ¥  
  task_progress <step> [total] [desc]    # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é€šçŸ¥

è¨­å®š (ç’°å¢ƒå¤‰æ•°):
  CLAUDE_VOICE_ENABLED=true             # éŸ³å£°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
  CLAUDE_VOICE_LANG=ja-JP               # éŸ³å£°è¨€èª
  CLAUDE_VOICE_RATE=1.0                 # è©±é€Ÿ (0.5-2.0)
  CLAUDE_VOICE_VOLUME=0.7               # éŸ³é‡ (0.0-1.0)

ä¾‹:
  source .claude/hooks/task-narrator
  task_start "ã‚³ãƒŸãƒƒãƒˆå‡¦ç†" "commit"
  task_progress "1" "3" "å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­"
  task_complete "commit" "success"

ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :
  - macOS (say ã‚³ãƒãƒ³ãƒ‰)
  - Linux (espeak ã¾ãŸã¯ spd-say)
  - Windows (PowerShell)
EOF
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆï¼‰
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    case "${1:-help}" in
        "start")
            task_start "$2" "$3"
            ;;
        "complete")
            task_complete "$2" "$3"
            ;;
        "progress")
            task_progress "$2" "$3" "$4"
            ;;
        "help"|*)
            show_usage
            ;;
    esac
fi