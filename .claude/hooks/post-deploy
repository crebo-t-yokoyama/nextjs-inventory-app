#!/bin/bash

# Post-deploy hook for Next.js Application Template
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ Claude Code ã«ã‚ˆã‚‹æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™

set -e

echo "âœ… Post-deployment verification..."

# ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆURLï¼ˆç’°å¢ƒå¤‰æ•°ã§è¨­å®šå¯èƒ½ï¼‰
DEPLOY_URL=${DEPLOY_URL:-"https://your-app.vercel.app"}

# 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ Running health checks..."
if command -v curl &> /dev/null; then
    # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ç¢ºèª
    echo "ğŸ” Checking main page..."
    if curl -f -s "$DEPLOY_URL" > /dev/null; then
        echo "âœ… Main page is accessible"
    else
        echo "âŒ Main page is not accessible"
        exit 1
    fi
    
    # API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª
    echo "ğŸ” Checking API endpoints..."
    if curl -f -s "$DEPLOY_URL/api/health" > /dev/null 2>&1; then
        echo "âœ… API endpoints are responsive"
    else
        echo "âš ï¸  API health check endpoint not found - manual verification recommended"
    fi
    
    # èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª
    if curl -f -s "$DEPLOY_URL/api/auth/providers" > /dev/null 2>&1; then
        echo "âœ… Authentication endpoints are accessible"
    else
        echo "âš ï¸  Authentication endpoints may need verification"
    fi
else
    echo "âš ï¸  curl not available - manual health checks required"
fi

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
echo "ğŸ—„ï¸  Verifying database connectivity..."
echo "âš ï¸  Ensure database is accessible from production environment"
echo "ğŸ“Š Check Supabase dashboard for connection status"

# 3. ç’°å¢ƒå¤‰æ•°ç¢ºèªï¼ˆæœ¬ç•ªç’°å¢ƒã§ï¼‰
echo "âš™ï¸  Environment configuration status..."
echo "âœ… Production environment variables should be verified via platform dashboard"

# 4. ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šç¢ºèª
echo "ğŸ“Š Checking monitoring setup..."
echo "âš ï¸  Verify the following monitoring is active:"
echo "  - Error tracking (Sentry/similar)"
echo "  - Performance monitoring"
echo "  - Uptime monitoring"
echo "  - Database monitoring"

# 5. ãƒ­ã‚°ç¢ºèª
echo "ğŸ“‹ Checking deployment logs..."
echo "âš ï¸  Review deployment logs for any warnings or errors"
echo "ğŸ“Š Monitor application logs for the first few minutes"

# 6. CDN/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
echo "ğŸŒ Checking CDN and cache status..."
if command -v curl &> /dev/null; then
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèª
    echo "ğŸ” Checking cache headers..."
    cache_headers=$(curl -I -s "$DEPLOY_URL" | grep -i cache || echo "No cache headers found")
    echo "ğŸ“Š Cache headers: $cache_headers"
fi

# 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
echo "ğŸ” Verifying security headers..."
if command -v curl &> /dev/null; then
    echo "ğŸ” Checking security headers..."
    security_headers=$(curl -I -s "$DEPLOY_URL" | grep -E -i "(x-frame-options|x-content-type-options|strict-transport-security)" || echo "Some security headers may be missing")
    echo "ğŸ”’ Security headers status: $security_headers"
fi

# 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆæœŸç¢ºèª
echo "âš¡ Initial performance check..."
if command -v curl &> /dev/null; then
    echo "ğŸ” Measuring response time..."
    response_time=$(curl -o /dev/null -s -w '%{time_total}' "$DEPLOY_URL")
    echo "â±ï¸  Response time: ${response_time}s"
    
    # è­¦å‘Šã—ãã„å€¤ï¼ˆ5ç§’ï¼‰
    if (( $(echo "$response_time > 5.0" | bc -l 2>/dev/null || echo "0") )); then
        echo "âš ï¸  Response time is slower than expected"
    else
        echo "âœ… Response time is acceptable"
    fi
fi

# 9. è‡ªå‹•é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
echo "ğŸ“¢ Deployment notification..."
echo "âœ… Deployment completed successfully at $(date)"
echo "ğŸŒ Application URL: $DEPLOY_URL"

# Slack/Discordé€šçŸ¥ï¼ˆç’°å¢ƒå¤‰æ•°ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
if [ -n "$SLACK_WEBHOOK_URL" ]; then
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"ğŸš€ Deployment completed: $DEPLOY_URL\"}" \
        "$SLACK_WEBHOOK_URL" || echo "âš ï¸  Slack notification failed"
fi

# 10. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æ¨å¥¨äº‹é …
echo ""
echo "ğŸ“‹ Recommended next steps:"
echo "  1. Monitor error rates for the next 30 minutes"
echo "  2. Check user feedback/support channels"
echo "  3. Verify critical user flows manually"
echo "  4. Review performance metrics"
echo "  5. Confirm backup systems are operational"

echo ""
echo "âœ… Post-deployment verification completed!"
echo "ğŸ‰ Deployment successful - monitor for any issues"